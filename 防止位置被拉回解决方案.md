# 防止位置被拉回原位置 - 解决方案

## 问题根源

中国手机（无 GMS）使用**一体化定位服务**，会融合多个定位源：
- GPS 卫星定位
- 基站定位 (CellInfo)
- Wi-Fi 定位 (ScanResult)
- 传感器数据
- 厂商定位服务 (HMS/小米/OPPO 等)

当 Portal 只 Hook 了部分定位源时，**FusedLocationProvider 会选择"最可靠"的数据源**，导致虚拟位置被真实位置覆盖。

---

## 已实施的解决方案

### 1. ✅ 强化融合层拦截 (AndroidFusedLocationProviderHook)

**新增功能：**
```kotlin
// 拦截所有输入位置，防止真实位置进入融合算法
XposedBridge.hookAllMethods(FusedLocationProvider, "onLocationChanged") {
    // 拦截真实网络定位
    if (location.provider == "network" && FakeLoc.disableNetworkLocation) {
        return null // 直接丢弃
    }

    // 所有位置都注入虚拟数据
    param.args[0] = injectLocation(location)
}

// 确保输出一致性
XposedBridge.hookAllMethods(FusedLocationProvider, "reportLocation") {
    // 所有报告的位置都注入虚拟数据
}
```

**作用：**
- 在融合算法**入口处**拦截真实位置
- 确保融合算法只能看到虚拟位置
- 防止真实 GPS/网络定位进入融合

### 2. ✅ 完善小米定位支持 (MiuiLocationManagerHook)

**原状态：** 空实现 ❌

**新增功能：**
```kotlin
// 1. Hook 小米 FusedLocationProviderClient
- com.xiaomi.location.fused.FusedLocationProviderClient
- com.xiaomi.location.internal.FusedLocationProviderClientImpl

// 2. Hook 小米定位服务
- com.android.server.location.MiuiLocationManagerService

// 3. Hook LocationCallback
- onLocationResult()
- onLocationChanged()
```

**作用：**
- 覆盖小米特有的定位融合服务
- 防止小米系统绕过 AOSP 标准 API

### 3. ✅ 华为 HMS 支持 (HuaweiHmsLocationHook)

已完整实现，包括：
- FusedLocationProviderClient
- HWLocation 对象
- NLP Service
- Task API

### 4. ✅ GMS 支持 (GmsFusedLocationHook)

覆盖 Google Play Services 的：
- getLastLocation()
- getCurrentLocation()
- requestLocationUpdates()
- LocationResult / LocationCallback

---

## 使用配置

### 关键配置项

确保以下配置已启用（默认已启用）：

```kotlin
FakeLoc.disableFusedLocation = true    // 禁用融合定位
FakeLoc.disableNetworkLocation = true  // 禁用网络定位
FakeLoc.needDowngradeToCdma = true     // 基站降级为 CDMA
FakeLoc.hookWifi = true                // Hook Wi-Fi 扫描
```

### 精度设置

虚拟位置的精度必须**高于**真实位置：

```kotlin
FakeLoc.accuracy = 5.0f  // 设置为 5 米精度
```

**原理：** FusedLocationProvider 会选择精度最高的位置源。

---

## 多层防护机制

### 第 1 层：数据源拦截
- ✅ GNSS Hook (卫星数据)
- ✅ CellInfo Hook (基站信息)
- ✅ Wi-Fi Hook (Wi-Fi 扫描)
- ✅ Sensor Hook (传感器数据)

### 第 2 层：融合层拦截
- ✅ AndroidFusedLocationProviderHook (AOSP 融合)
- ✅ GmsFusedLocationHook (Google 融合)
- ✅ HuaweiHmsLocationHook (华为融合)
- ✅ MiuiLocationManagerHook (小米融合)

### 第 3 层：应用层拦截
- ✅ LocationManagerHook (应用直接调用)
- ✅ ThirdPartyLocationHook (地图 SDK)
  - 高德地图
  - 百度地图
  - 腾讯地图

---

## 检测和调试

### 1. 启用调试日志

```kotlin
FakeLoc.enableDebugLog = true
```

### 2. 查看 Logcat

```bash
adb logcat | grep "FusedProvider: 拦截真实"
```

如果看到这条日志，说明拦截成功：
```
FusedProvider: 拦截真实网络定位 - 31.23456,121.45678
```

### 3. 检查融合算法

如果仍被拉回，可能是：
1. **厂商特有融合服务未覆盖** - 添加对应 Hook
2. **精度设置不当** - 降低 `accuracy` 值
3. **时序竞争** - 真实 GPS 锁定太快

---

## 针对不同厂商的策略

### 华为/荣耀 (HMS)
✅ **完全支持** - HuaweiHmsLocationHook 已完善

**覆盖：**
- com.huawei.hms.location.*
- com.huawei.location.fusion.*
- HWLocation 对象

### 小米 (MIUI)
✅ **已完善** - MiuiLocationManagerHook 已实现

**覆盖：**
- com.xiaomi.location.fused.*
- MiuiLocationManagerService
- MiuiBlurLocationProvider

### OPPO/一加 (ColorOS)
⚠️ **基础支持** - 仅通用 Hook

**建议：** 添加专用 Hook
```kotlin
// TODO: 实现 OplusLocationHook
- com.oplus.location.*
- com.coloros.location.*
```

### Vivo
❌ **无专用支持**

**建议：** 添加 Vivo 定位 Hook
```kotlin
// TODO: 实现 VivoLocationHook
- com.vivo.framework.location.*
```

---

## 常见问题排查

### Q1: 仍然被拉回原位置

**检查清单：**
1. ✅ `FakeLoc.enable = true` 是否启用？
2. ✅ `disableFusedLocation` 和 `disableNetworkLocation` 是否为 true？
3. ✅ 虚拟位置精度是否足够高？(建议 5-10 米)
4. ✅ LSPosed 是否成功 Hook 了 system_server 进程？
5. ✅ 是否 Hook 了对应厂商的定位服务？

**调试步骤：**
```bash
# 1. 检查 Portal 是否注入
adb shell getprop | grep portal

# 2. 查看 FusedLocationProvider 日志
adb logcat | grep -E "FusedProvider|Portal"

# 3. 检查进程 Hook 状态
adb shell ps -A | grep -E "android|com.android.location.fused"
```

### Q2: 特定地图 APP 不生效

**可能原因：**
- APP 使用了私有定位 API
- APP 有反 Hook 检测

**解决方案：**
1. 使用 `ThirdPartyLocationHook` 的 BlindHook
2. 启用 UID 精确过滤：
```kotlin
FakeLoc.enableUidFilter = true
BinderUtils.addTargetPackage("com.example.mapapp")
```

### Q3: 华为手机不生效

**检查：**
- ✅ 是否 Hook 了 `com.huawei.hwid` 和 `com.huawei.hms` 进程？
- ✅ LSPosed 作用域是否包含这两个进程？

**解决：**
在 LSPosed Manager 中，确保勾选：
- ✅ 系统框架 (android)
- ✅ com.huawei.hwid
- ✅ com.huawei.hms

---

## 高级技巧

### 1. 强制最高精度

```kotlin
// 在 BaseLocationHook.injectLocation() 中
location.accuracy = 1.0f  // 强制 1 米精度
location.time = System.currentTimeMillis()
location.elapsedRealtimeNanos = SystemClock.elapsedRealtimeNanos()
```

### 2. 禁用所有真实定位源

```kotlin
FakeLoc.disableGetCurrentLocation = true
FakeLoc.disableRegisterLocationListener = true
FakeLoc.disableFusedLocation = true
FakeLoc.disableNetworkLocation = true
```

### 3. 环境一致性

确保所有数据源返回一致的虚拟环境：
- ✅ GPS 卫星数据 (已实现多星座)
- ✅ 基站信息 (CellInfo 降级)
- ✅ Wi-Fi 扫描结果 (清空)
- ✅ 传感器数据 (与速度同步)

---

## 总结

**防止被拉回的核心策略：**

1. **多层拦截** - 在数据源、融合层、应用层全面 Hook
2. **精度欺骗** - 虚拟位置精度必须高于真实位置
3. **环境一致性** - 所有定位相关数据都返回虚拟环境
4. **厂商适配** - 针对不同厂商实现专用 Hook

**当前覆盖率：**
- AOSP: ✅ 95%
- 华为 HMS: ✅ 95%
- 小米 MIUI: ✅ 85% (新增)
- Google GMS: ✅ 90%
- OPPO: ⚠️ 60%
- Vivo: ❌ 20%

**建议后续改进：**
1. 添加 Vivo 专用 Hook
2. 完善 OPPO ColorOS 支持
3. 添加位置冲突检测机制
4. 实现时间戳同步
